# è¯„è®ºç‚¹èµç¼“å­˜æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©

## é—®é¢˜èƒŒæ™¯

åœ¨å®ç°è¯„è®ºç‚¹èµåŠŸèƒ½æ—¶ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„ç¼“å­˜æ–¹æ¡ˆã€‚ä¸»è¦è€ƒè™‘å› ç´ ï¼š
- æ€§èƒ½ï¼ˆæŸ¥è¯¢é€Ÿåº¦ã€å†…å­˜å ç”¨ï¼‰
- æ•°æ®ç»“æ„çš„çµæ´»æ€§
- ä»£ç çš„å¯ç»´æŠ¤æ€§
- ä¸é¡¹ç›®æ¶æ„çš„ä¸€è‡´æ€§

## ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1ï¼šçº¯ Redis Templateï¼ˆåŸæ–¹æ¡ˆï¼‰

**å®ç°æ–¹å¼**ï¼š
```java
// ä½¿ç”¨ Redis Set å­˜å‚¨ç‚¹èµå…³ç³»
comment:like:{commentId} -> Set<userId>

// ä½¿ç”¨ Redis String å­˜å‚¨ç‚¹èµæ•°é‡
comment:like:count:{commentId} -> count
```

**ä¼˜åŠ¿**ï¼š
- âœ… åˆ©ç”¨ Redis åŸç”Ÿæ•°æ®ç»“æ„ï¼ˆSetï¼‰
- âœ… `SISMEMBER` åˆ¤æ–­ç‚¹èµ O(1) æ—¶é—´å¤æ‚åº¦
- âœ… `SCARD` è·å–ç‚¹èµæ•° O(1) æ—¶é—´å¤æ‚åº¦
- âœ… å¯ä»¥è·å–æ‰€æœ‰ç‚¹èµç”¨æˆ·åˆ—è¡¨
- âœ… å†…å­˜å ç”¨æœ€ä¼˜ï¼ˆä¸€ä¸ªè¯„è®ºä¸€ä¸ª Setï¼‰
- âœ… æ”¯æŒé›†åˆæ“ä½œï¼ˆäº¤é›†ã€å¹¶é›†ç­‰ï¼‰

**åŠ£åŠ¿**ï¼š
- âŒ éœ€è¦æ‰‹åŠ¨ç®¡ç†ç¼“å­˜é€»è¾‘
- âŒ ä»£ç ç›¸å¯¹å¤æ‚
- âŒ ä¸é¡¹ç›®å…¶ä»–æ¨¡å—é£æ ¼ä¸ä¸€è‡´

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦é«˜æ€§èƒ½çš„ç‚¹èµåˆ¤æ–­
- éœ€è¦è·å–ç‚¹èµç”¨æˆ·åˆ—è¡¨
- ç‚¹èµæ•°æ®é‡å¤§ï¼Œå†…å­˜æ•æ„Ÿ

---

### æ–¹æ¡ˆ 2ï¼šçº¯ Spring Cache

**å®ç°æ–¹å¼**ï¼š
```java
// æ¯ä¸ªç”¨æˆ·çš„ç‚¹èµçŠ¶æ€ç‹¬ç«‹ç¼“å­˜
comment:like:status:{commentId}:{userId} -> Boolean

// ç‚¹èµæ•°é‡ç¼“å­˜
comment:like:count:{commentId} -> Integer
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä½¿ç”¨ Spring Cache æ³¨è§£ï¼Œä»£ç ç®€æ´
- âœ… ä¸é¡¹ç›®å…¶ä»–æ¨¡å—é£æ ¼ä¸€è‡´
- âœ… è‡ªåŠ¨å¤„ç†åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… æ˜“äºç»´æŠ¤å’Œç†è§£

**åŠ£åŠ¿**ï¼š
- âŒ æ¯ä¸ªç”¨æˆ·ç‚¹èµçŠ¶æ€æ˜¯ç‹¬ç«‹çš„ key
- âŒ æ— æ³•åˆ©ç”¨ Redis Set çš„é›†åˆæ“ä½œ
- âŒ å†…å­˜å ç”¨å¤§ï¼ˆN ä¸ªç”¨æˆ· = N ä¸ª keyï¼‰
- âŒ æ— æ³•è·å–æŸè¯„è®ºçš„æ‰€æœ‰ç‚¹èµç”¨æˆ·
- âŒ æ‰¹é‡æŸ¥è¯¢æ•ˆç‡ä½

**é€‚ç”¨åœºæ™¯**ï¼š
- åªéœ€è¦ç®€å•çš„ç‚¹èµåˆ¤æ–­
- ä¸éœ€è¦è·å–ç‚¹èµç”¨æˆ·åˆ—è¡¨
- è¿½æ±‚ä»£ç ä¸€è‡´æ€§å’Œç®€æ´æ€§

---

### æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰

**å®ç°æ–¹å¼**ï¼š
```java
// Redis Set å­˜å‚¨ç‚¹èµå…³ç³»ï¼ˆä½¿ç”¨ Redis Templateï¼‰
comment:like:set:{commentId} -> Set<userId>

// Spring Cache ç¼“å­˜ç‚¹èµæ•°é‡
comment:like:count:{commentId} -> Integer (Spring Cache)
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç»“åˆä¸¤ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹
- âœ… ç‚¹èµå…³ç³»ç”¨ Redis Setï¼Œæ€§èƒ½æœ€ä¼˜
- âœ… ç‚¹èµæ•°é‡ç”¨ Spring Cacheï¼Œä»£ç ç®€æ´
- âœ… å†…å­˜å ç”¨åˆç†
- âœ… å¯ä»¥è·å–ç‚¹èµç”¨æˆ·åˆ—è¡¨
- âœ… éƒ¨åˆ†éµå¾ªé¡¹ç›®è§„èŒƒ

**åŠ£åŠ¿**ï¼š
- âš ï¸ æ··åˆä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼Œéœ€è¦ç†è§£ä¸¤å¥—æœºåˆ¶

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦å¹³è¡¡æ€§èƒ½å’Œä»£ç è´¨é‡
- éœ€è¦çµæ´»çš„æ•°æ®æ“ä½œ
- æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ

---

## è¯¦ç»†å¯¹æ¯”è¡¨

| ç‰¹æ€§ | æ–¹æ¡ˆ1: çº¯Redis | æ–¹æ¡ˆ2: çº¯Spring Cache | æ–¹æ¡ˆ3: æ··åˆæ–¹æ¡ˆ |
|------|---------------|---------------------|----------------|
| **æ€§èƒ½** |
| ç‚¹èµåˆ¤æ–­é€Ÿåº¦ | â­â­â­â­â­ O(1) | â­â­â­â­ O(1) | â­â­â­â­â­ O(1) |
| è·å–ç‚¹èµæ•° | â­â­â­â­â­ O(1) | â­â­â­â­ O(1) | â­â­â­â­â­ O(1) |
| æ‰¹é‡æŸ¥è¯¢ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ |
| å†…å­˜å ç”¨ | â­â­â­â­â­ æœ€ä¼˜ | â­â­ è¾ƒå¤§ | â­â­â­â­ è‰¯å¥½ |
| **åŠŸèƒ½** |
| ç‚¹èµåˆ¤æ–­ | âœ… | âœ… | âœ… |
| è·å–ç‚¹èµæ•° | âœ… | âœ… | âœ… |
| è·å–ç‚¹èµç”¨æˆ·åˆ—è¡¨ | âœ… | âŒ | âœ… |
| é›†åˆæ“ä½œ | âœ… | âŒ | âœ… |
| **å¼€å‘ä½“éªŒ** |
| ä»£ç ç®€æ´åº¦ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| å¯ç»´æŠ¤æ€§ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| ä¸é¡¹ç›®ä¸€è‡´æ€§ | â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| å­¦ä¹ æˆæœ¬ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

---

## å†…å­˜å ç”¨å¯¹æ¯”

å‡è®¾æœ‰ 1000 ä¸ªè¯„è®ºï¼Œæ¯ä¸ªè¯„è®ºå¹³å‡ 100 ä¸ªç‚¹èµï¼š

### æ–¹æ¡ˆ 1ï¼šçº¯ Redis Template
```
1000 ä¸ªè¯„è®º Ã— 1 ä¸ª Set = 1000 ä¸ª key
1000 ä¸ªè¯„è®º Ã— 1 ä¸ª count = 1000 ä¸ª key
æ€»è®¡ï¼š2000 ä¸ª key

æ¯ä¸ª Set å­˜å‚¨ 100 ä¸ª userId (Long)
å†…å­˜ä¼°ç®—ï¼š1000 Ã— (100 Ã— 8 bytes) â‰ˆ 800 KB
```

### æ–¹æ¡ˆ 2ï¼šçº¯ Spring Cache
```
1000 ä¸ªè¯„è®º Ã— 100 ä¸ªç”¨æˆ· = 100,000 ä¸ªç‚¹èµçŠ¶æ€ key
1000 ä¸ªè¯„è®º Ã— 1 ä¸ª count = 1000 ä¸ª key
æ€»è®¡ï¼š101,000 ä¸ª key

å†…å­˜ä¼°ç®—ï¼š100,000 Ã— (key + value) â‰ˆ 10 MB
```

### æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆ
```
1000 ä¸ªè¯„è®º Ã— 1 ä¸ª Set = 1000 ä¸ª key
1000 ä¸ªè¯„è®º Ã— 1 ä¸ª count (Spring Cache) = 1000 ä¸ª key
æ€»è®¡ï¼š2000 ä¸ª key

å†…å­˜ä¼°ç®—ï¼šâ‰ˆ 800 KB (ä¸æ–¹æ¡ˆ1ç›¸åŒ)
```

**ç»“è®º**ï¼šæ–¹æ¡ˆ 2 çš„å†…å­˜å ç”¨æ˜¯æ–¹æ¡ˆ 1/3 çš„ **12.5 å€**ï¼

---

## ä»£ç ç¤ºä¾‹å¯¹æ¯”

### åˆ¤æ–­æ˜¯å¦ç‚¹èµ

**æ–¹æ¡ˆ 1ï¼šçº¯ Redis**
```java
public Boolean isLiked(Long commentId, Long userId) {
    String key = "comment:like:" + commentId;
    return stringRedisTemplate.opsForSet().isMember(key, userId.toString());
}
```

**æ–¹æ¡ˆ 2ï¼šçº¯ Spring Cache**
```java
@Cacheable(value = "commentLikeStatus", key = "#commentId + ':' + #userId")
public Boolean isLiked(Long commentId, Long userId) {
    // æŸ¥è¯¢æ•°æ®åº“
    return bookCommentLikeMapper.selectCount(
        new QueryWrapper<>()
            .eq("comment_id", commentId)
            .eq("user_id", userId)
    ) > 0;
}
```

**æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆ**
```java
public Boolean isLiked(Long commentId, Long userId) {
    String setKey = "comment:like:set:" + commentId;
    
    // ä¼˜å…ˆä» Redis Set æŸ¥è¯¢
    if (stringRedisTemplate.hasKey(setKey)) {
        return stringRedisTemplate.opsForSet().isMember(setKey, userId.toString());
    }
    
    // æœªå‘½ä¸­åˆ™æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜
    boolean liked = bookCommentLikeMapper.selectCount(...) > 0;
    if (liked) {
        stringRedisTemplate.opsForSet().add(setKey, userId.toString());
    }
    return liked;
}
```

---

## æ¨èæ–¹æ¡ˆ

### ğŸ† æ¨èï¼šæ–¹æ¡ˆ 3ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

**ç†ç”±**ï¼š
1. **æ€§èƒ½æœ€ä¼˜**ï¼šåˆ©ç”¨ Redis Set çš„ O(1) æ“ä½œ
2. **å†…å­˜é«˜æ•ˆ**ï¼šé¿å…ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹ key
3. **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒè·å–ç‚¹èµç”¨æˆ·åˆ—è¡¨
4. **ä»£ç è´¨é‡**ï¼šéƒ¨åˆ†ä½¿ç”¨ Spring Cacheï¼Œä¿æŒä¸€è‡´æ€§
5. **çµæ´»æ€§**ï¼šå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ç­–ç•¥

### å®ç°å»ºè®®

```java
@Component
public class CommentLikeCacheManager {
    
    // ç‚¹èµå…³ç³»ï¼šä½¿ç”¨ Redis Setï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰
    public Boolean isLiked(Long commentId, Long userId) {
        // ä½¿ç”¨ Redis Set
    }
    
    public void addLikeToSet(Long commentId, Long userId) {
        // ä½¿ç”¨ Redis Set
    }
    
    // ç‚¹èµæ•°é‡ï¼šä½¿ç”¨ Spring Cacheï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
    @Cacheable(value = "commentLikeCount")
    public Integer getLikeCount(Long commentId) {
        // Spring Cache è‡ªåŠ¨ç¼“å­˜
    }
    
    @CachePut(value = "commentLikeCount", key = "#commentId")
    public Integer updateLikeCount(Long commentId, Integer count) {
        return count;
    }
}
```

---

## è¿ç§»å»ºè®®

å¦‚æœå½“å‰ä½¿ç”¨æ–¹æ¡ˆ 1ï¼Œæƒ³è¦éƒ¨åˆ†é‡‡ç”¨ Spring Cacheï¼š

### ç¬¬ä¸€æ­¥ï¼šä¿ç•™ Redis Set
```java
// ä¿ç•™ç‚¹èµå…³ç³»çš„ Redis Set æ“ä½œ
comment:like:set:{commentId} -> Set<userId>
```

### ç¬¬äºŒæ­¥ï¼šç‚¹èµæ•°é‡æ”¹ç”¨ Spring Cache
```java
// å°†ç‚¹èµæ•°é‡æ”¹ä¸º Spring Cache
@Cacheable(value = "commentLikeCount")
public Integer getLikeCount(Long commentId) {
    return bookCommentMapper.selectById(commentId).getLikeCount();
}
```

### ç¬¬ä¸‰æ­¥ï¼šé€æ­¥ä¼˜åŒ–
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- è°ƒæ•´è¿‡æœŸæ—¶é—´
- ä¼˜åŒ–é¢„çƒ­ç­–ç•¥

---

## æ€»ç»“

| å¦‚æœä½ éœ€è¦... | æ¨èæ–¹æ¡ˆ |
|-------------|---------|
| æœ€é«˜æ€§èƒ½ + æœ€ä½å†…å­˜ | æ–¹æ¡ˆ 1 |
| æœ€ç®€æ´ä»£ç  + é¡¹ç›®ä¸€è‡´æ€§ | æ–¹æ¡ˆ 2 |
| å¹³è¡¡æ€§èƒ½å’Œä»£ç è´¨é‡ | **æ–¹æ¡ˆ 3** â­ |
| è·å–ç‚¹èµç”¨æˆ·åˆ—è¡¨ | æ–¹æ¡ˆ 1 æˆ– 3 |
| å¿«é€Ÿå¼€å‘åŸå‹ | æ–¹æ¡ˆ 2 |
| ç”Ÿäº§ç¯å¢ƒæ¨è | **æ–¹æ¡ˆ 3** â­ |

**æœ€ç»ˆå»ºè®®**ï¼šé‡‡ç”¨**æ–¹æ¡ˆ 3ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰**ï¼Œæ—¢ä¿è¯äº†æ€§èƒ½ï¼Œåˆéƒ¨åˆ†éµå¾ªäº†é¡¹ç›®çš„ Spring Cache è§„èŒƒã€‚
